#!/usr/bin/env python
#
# Copyright (c) 2025 Sung Pae <self@sungpae.com>
# Distributed under the MIT license.
# http://www.opensource.org/licenses/mit-license.php

"""
Add newlines to the end of non-empty files that do not end in a newline.

Newlines in POSIX text files are line **terminators**, not delimiters.
"""

import os
import sys
from argparse import ArgumentParser, RawDescriptionHelpFormatter
from typing import Sequence


def parser() -> ArgumentParser:
    parser = ArgumentParser(description=__doc__)
    parser.formatter_class = RawDescriptionHelpFormatter
    parser.add_argument("paths", nargs="+")
    return parser


def main(args: Sequence[str]) -> int:
    opts = parser().parse_args(args)
    for path in opts.paths:
        with open(path, "rb") as f:
            if os.fstat(f.fileno()).st_size == 0:
                continue
            f.seek(-1, os.SEEK_END)
            if f.read(1) == b"\n":
                continue
        with open(path, "ab") as f:
            print(f"Adding missing final newline to {path}", file=sys.stderr)
            f.write(b"\n")
    return 0


if __name__ == "__main__":
    sys.exit(main(sys.argv[1:]))
