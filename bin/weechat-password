#!/usr/bin/env ruby
# -*- encoding: utf-8 -*-
#
# Copyright (c) 2011 Sung Pae <self@sungpae.com>
# Distributed under the MIT license.
# http://www.opensource.org/licenses/mit-license.php

require 'optparse'
require 'etc'

class WeechatPassword
  def initialize args = []
    @args = args.freeze
  end

  def options
    OptionParser.new do |opt|
      opt.banner = %Q(\
        Authenticate to an IRC server with the password given on stdin via the
        Weechat FIFO writer.

        Usage: #{File.basename __FILE__} [options] [username [server]]

        Username is `#{Etc.getlogin}` and server is `freenode` by default.
      ).gsub /^ +/, ''
    end
  end

  def fifo
    fs = Dir[File.expand_path '~/.weechat/weechat_fifo_*']
    raise 'Multiple Weechat FIFO files!' if fs.size > 1
    fs.first
  end

  def authenticate username = Etc.getlogin, server = 'freenode'
    password = $stdin.read.chomp

    case server
    when 'freenode'
      File.open fifo, 'w' do |io|
        io.puts "irc.server.freenode */msg NickServ identify #{username} #{password}"
      end
    else raise 'Unknown IRC server: ' + server
    end
  end

  def run
    args = options.parse @args
    abort options.to_s if args.size > 2
    authenticate *args
  end
end

WeechatPassword.new(ARGV).run if $0 == __FILE__
