#!/usr/bin/env ruby
# -*- encoding: utf-8 -*-
#
# Copyright (c) 2015 Sung Pae <self@sungpae.com>
# Distributed under the MIT license.
# http://www.opensource.org/licenses/mit-license.php

require 'optparse'
require 'shellwords'

@groups = %w[nerv nerv-alt]
@verbose = false

OptionParser.new nil, 24 do |opt|
  opt.on '-g', '--groups A,B,C', Array, "DEFAULT: #{@groups.join(',')}" do |arg|
    @groups = arg
  end

  opt.on '-v', '--verbose' do
    @verbose = true
  end
end.parse ARGV

def warn msg
  $stderr.puts msg if @verbose
end

%x(pacman --query --groups #{@groups.shelljoin}).each_line do |line|
  pkg = line.split[1]
  upstream = pkg[/(.*)-(nerv|alt)$/, 1]

  if upstream.nil?
    warn "∄ #{pkg}"
    next
  end

  v2 = %x(pacman --sync --info #{upstream.shellescape} 2>/dev/null)[/Version\s*:\s*(.*)/, 1]

  if $?.exitstatus != 0
    warn "∄ #{pkg}"
    next
  end

  v1 = %x(pacman --query --info #{pkg.shellescape})[/Version\s*:\s*\S*?(\d.*)/, 1]
  cmp = %x(vercmp #{v1.shellescape} #{v2.shellescape}).to_i

  if cmp < 0
    puts "✖ #{pkg}: #{v1} < #{v2}"
  else
    warn "✔ #{pkg}"
  end
end
