#!/usr/bin/env ruby
# -*- encoding: utf-8 -*-

pidfile = File.expand_path '~/.offlineimap/pid'
port = '3346'

def running? pid
  Process.kill 0, pid
rescue Errno::ESRCH
  false
end

if File.exists? pidfile and running? File.read(pidfile).to_i
  abort 'Offlineimap is already running!'
end

fork do
  addrs = %x(dig +short imap.gmail.com smtp.gmail.com | grep '^[0-9]').lines.map &:strip
  exec *(%W[sudo /opt/sshuttle/sshuttle -v -l 127.0.0.1:#{port} -r guns@sungpae.com] + addrs)
end

sleep 0.5 until system 'nc', '-z', '127.0.0.1', port

offlineimap_pid = fork do
  exec 'offlineimap'
end

%w[INT QUIT TERM].each do |sig|
  trap sig do
    puts "Caught SIG#{sig}; sending SIGQUIT to offlineimap (#{offlineimap_pid})"
    Process.kill :QUIT, offlineimap_pid
    Process.waitall
  end
end

Process.waitall
