#!/usr/bin/env ruby
# -*- encoding: utf-8 -*-

require 'shellwords'

def running? pid
  Process.kill 0, pid
rescue Errno::ESRCH
  false
end

pidfile = File.expand_path '~/.offlineimap/pid'

if File.exists? pidfile and running? File.read(pidfile).to_i
  abort 'Offlineimap is already running!'
end

offlineimap_pid = fork { exec 'offlineimap' }

%w[INT QUIT TERM].each do |sig|
  trap sig do
    puts "Caught SIG#{sig}; sending SIGQUIT to offlineimap (#{offlineimap_pid})"
    Process.kill :QUIT, offlineimap_pid
    Process.waitall
  end
end

Process.waitall
