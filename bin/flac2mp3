#!/usr/bin/env ruby
# -*- encoding: utf-8 -*-
#
# Copyright (c) 2011 Sung Pae <self@sungpae.com>
# Distributed under the MIT license.
# http://www.opensource.org/licenses/mit-license.php

require 'optparse'
require 'fileutils'
require 'shellwords'

class Flac2mp3
  def initialize args = []
    @args = args.freeze
    @opts = { :jobs => 1 }
  end

  def options
    OptionParser.new do |opt|
      opt.banner = %Q(\
        Usage: #{File.basename __FILE__} [options] [file|dir ...]

        Options:
      ).gsub /^ +/, ''

      opt.on '-r', '--recurse' do
        @opts[:recurse] = true
      end

      opt.on '-o', '--outdir DIR' do |arg|
        @opts[:outdir] = File.expand_path arg
      end

      opt.on '-j', '--jobs N', Integer do |arg|
        @opts[:jobs] = arg
      end
    end
  end

  def filter paths
    paths.map do |path|
      if File.directory? path
        pat = @opts[:recurse] ? '**/*.flac' : '*.flac'
        Dir[File.join path, pat]
      else
        path if File.extname(path) == '.flac'
      end
    end.compact.flatten
  end

  def id3tags path
    opts = [%w[--tt TITLE], %w[--ta ARTIST], %w[--tl ALBUM], %w[--tn TRACKNUMBER], %w[--tg GENRE]]
    meta = Hash[%x(metaflac --export-tags-to=- #{path.shellescape}).lines.map { |l| l.chomp.split '=' }]

    opts.map { |flag, key| [flag, meta[key]] if meta.has_key? key }.compact.flatten
  end

  def mp3encode src, dst
    system %Q{
      flac -sdc #{src.shellescape} |
      lame --preset standard #{id3tags(src).shelljoin} - #{dst.shellescape}.mp3 2>/dev/null
    }
  end

  def process paths
    queue = filter paths
    count = queue.count
    label = "[%#{count.to_s.length}d/#{count}] Writing %s"

    idx, pool, lock = 0, [], Mutex.new

    @opts[:jobs].times do
      pool << Thread.new do

        loop do
          flac, i = lock.synchronize { n = idx; idx += 1; [queue[n], n] }
          break if flac.nil?

          base = @opts[:outdir] || File.dirname(flac)
          dst = File.join base, File.basename(flac, '.flac')
          FileUtils.mkdir_p base

          puts label % [i+1, (dst + '.mp3').inspect]
          raise 'Encoding error!' unless mp3encode flac, dst
        end

      end
    end

    pool.each &:join
  end

  def run
    args = options.parse @args
    process args.empty? ? %w[.] : args
  end
end

Flac2mp3.new(ARGV).run if $0 == __FILE__
