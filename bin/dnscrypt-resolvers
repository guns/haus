#!/usr/bin/env ruby
# -*- encoding: utf-8 -*-
#
# Copyright (c) 2015-2017 Sung Pae <self@sungpae.com>
# Distributed under the MIT license.
# http://www.opensource.org/licenses/mit-license.php

require 'csv'
require 'fileutils'

URL = 'https://raw.githubusercontent.com/jedisct1/dnscrypt-proxy/master/dnscrypt-resolvers.csv'
SIG = 'https://raw.githubusercontent.com/jedisct1/dnscrypt-proxy/master/dnscrypt-resolvers.csv.sig'

Dir.chdir '/tmp' do
  begin
    [URL, SIG].each { |u| system 'curl', '--silent', '-O', u }

    abort unless system 'gpg', '--verify-files', File.basename(SIG)

    csv = CSV.parse File.read(File.basename URL)

    csv.shift if csv[0][0] == 'Name'

    puts csv.map { |row|
      title, fullname, desc, loc, coord, url, version, dnssec, nologs, namecoin, addr, name, pubkey, pubkey_txt = row
      host, port = addr.split ':', 2

      <<-EOF
# #{fullname}
# #{desc}
# #{loc}#{" (#{coord})" if coord}
# #{url} (#{title})
# NOLOGS: #{nologs}, DNSSEC: #{dnssec}, Namecoin: #{namecoin}
# Version: #{version}
ProviderName    #{name}
ProviderKey     #{pubkey}
ResolverAddress #{host}#{port ? ":#{port}" : ""}
EOF
    }.join("\n")
  ensure
    FileUtils.rm_f [URL, SIG].map { |f| File.basename f }
  end
end
