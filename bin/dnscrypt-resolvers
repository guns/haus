#!/usr/bin/env ruby
# -*- encoding: utf-8 -*-

require 'csv'
require 'fileutils'

URL = 'https://raw.githubusercontent.com/jedisct1/dnscrypt-proxy/master/dnscrypt-resolvers.csv'
SIG = 'https://raw.githubusercontent.com/jedisct1/dnscrypt-proxy/master/dnscrypt-resolvers.csv.sig'

Dir.chdir '/tmp' do
  begin
    [URL, SIG].each { |u| system 'curl', '--silent', '-O', u }

    abort unless system 'gpg', '--verify-files', File.basename(SIG)

    csv = CSV.parse File.read(File.basename URL)

    csv.shift if csv[0][0] == 'Name'

    puts csv.map { |row|
      title, fullname, desc, loc, coord, url, version, dnssec, nologs, namecoin, addr, name, pubkey, pubkey_txt = row
      host, port = addr.split ':', 2

      <<-EOF
# #{fullname}
# #{desc}
# #{loc}#{" (#{coord})" if coord}
# #{url} (#{title})
# NOLOGS: #{nologs}, DNSSEC: #{dnssec}, Namecoin: #{namecoin}
# Version: #{version}
# DNSCRYPT_PROVIDER_NAME=#{name}
# DNSCRYPT_PROVIDER_KEY=#{pubkey}
# DNSCRYPT_RESOLVERIP=#{host}
# DNSCRYPT_RESOLVERPORT=#{port || '443'}
      EOF
    }.join("\n")
  ensure
    FileUtils.rm_f [URL, SIG].map { |f| File.basename f }
  end
end
