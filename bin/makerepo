#!/usr/bin/env ruby
# -*- encoding: utf-8 -*-

require 'set'

LIB_DIR = '/var/lib/pacman/local'
CACHE_DIR = '/var/cache/pacman/pkg'
HOSTNAME = ENV['HOSTNAME'] || %x(hostname).chomp
DB = "#{CACHE_DIR}/#{HOSTNAME}.db.tar.gz"
DB_MTIME = File.exists?(DB) ? File.stat(DB).mtime : Time.at(0)
ARCH = %x(uname -m).chomp

cache = Set.new Dir[File.join CACHE_DIR, '*.pkg.tar.xz'].select { |f|
  File.stat(f).ctime > DB_MTIME
}

packages = Dir[File.join LIB_DIR, '*'].reduce [] do |v, f|
  base = File.join CACHE_DIR, File.basename(f)
  if cache.include? (any = base + '-any.pkg.tar.xz')
    v << any
  elsif cache.include? (arch = base + '-' + ARCH + '.pkg.tar.xz')
    v << arch
  else
    v
  end
end

packages.each do |pkg|
  if not File.exists? pkg + '.sig'
    system 'gpg', '--detach-sign', pkg
  end
end

system 'repo-add', '--new', '--sign', DB, *packages
