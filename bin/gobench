#!/usr/bin/env ruby
# -*- encoding: utf-8 -*-

require 'optparse'

cpu_list = '1'

OptionParser.new do |opt|
  opt.on '-c', '--cpu-list CPULIST' do |arg|
    cpu_list = arg
  end
end.parse! ARGV

def expand s
  IO.popen ['expand'], 'r+' do |io|
    io.write s
    io.close_write
    return io.read
  end
end

if $stdin.tty?
  puts %x(go version)
else
  puts "//\t#{%x(go version)}"
end

IO.popen ['taskset', '--cpu-list', cpu_list,
          'go', 'test', '-run=NONE', "-bench=#{ARGV[0] || '.'}", '-benchmem',
          *ARGV.drop(1)], 'r' do |io|
  if $stdin.tty?
    while line = io.gets("\n")
      puts line
    end
  else
    out = io.read
    puts expand(out).gsub(/^/, "//\t")
  end
end
