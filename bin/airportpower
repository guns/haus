#!/usr/bin/env ruby
# encoding: utf-8
#
# Copyright (c) 2010 Sung Pae <sung@metablu.com>
# Distributed under the MIT license.
# http://www.opensource.org/licenses/mit-license.php

require 'optparse'
require 'shellwords'

class Airportpower
  def initialize args = []
    @args = args
  end

  def options
    OptionParser.new %Q{\
      Set or toggle your Mac's airport card via `networksetup'.

      Usage: #{File.basename __FILE__} [on|off|toggle]
    }.gsub(/^ +/,'')
  end

  def status
    %x(networksetup -getairportpower en1 2>/dev/null)[/\w+$/].downcase
  end

  def switch cmd
    %x(networksetup -setairportpower en1 #{cmd.shellescape} 2>/dev/null)
    cmd
  end

  def toggle
    switch (status == 'on' ? 'off' : 'on')
  end

  def run
    args = options.parse @args
    abort options.to_s if args.size > 1
    raise 'OS X only!' unless RUBY_PLATFORM[/darwin/]

    state = case arg = args.first
    when nil              then status
    when /\A(on|off)\z/i  then switch arg
    when 'toggle'         then toggle
    else abort options.to_s
    end

    puts "Airport is #{state}"
  end
end

Airportpower.new(ARGV).run if __FILE__ == $0
