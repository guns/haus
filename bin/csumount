#!/usr/bin/env ruby
# -*- encoding: utf-8 -*-
#
# Copyright (c) 2014-2015 Sung Pae <self@sungpae.com>
# Distributed under the MIT license.
# http://www.opensource.org/licenses/mit-license.php

require 'shellwords'

abort 'USAGE: csumount mountpoint' if ARGV.size != 1

def sh *argv
  warn argv.shelljoin
  system *argv
end

mountpoint = ARGV.first
dm_name = File.basename File.expand_path(mountpoint)

if sh 'umount', mountpoint
  sh 'cryptsetup', 'luksClose', dm_name
end

exit $?.exitstatus
