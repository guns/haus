#!/usr/bin/env ruby
# -*- encoding: utf-8 -*-
#
# Copyright (c) 2012 Sung Pae <self@sungpae.com>
# Distributed under the MIT license.
# http://www.opensource.org/licenses/mit-license.php

require 'optparse'
require 'ostruct'
require 'shellwords'
require 'nokogiri'

class Getip
  USER_AGENT = 'Mozilla/6.0 (Windows NT 6.2; WOW64; rv:16.0.1) Gecko/20121011 Firefox/16.0.1'

  attr_reader :options

  def initialize opts = {}
    @options = OpenStruct.new opts
    options.certfile ||= File.expand_path '~/.certificates/www.google.com.crt'
  end

  def parser
    @parser ||= OptionParser.new nil, 20 do |opt|
      opt.banner = <<-BANNER.gsub /^ +/, ''
        Determine public IP address as seen by google.com.

        Usage: #{File.basename __FILE__} [options]

        Options:
      BANNER

      opt.on '-f', '--certfile PATH', 'google.com certificate file', '[DEFAULT: %s]' % options.certfile do |arg|
        options.certfile = File.expand_path arg
      end
    end
  end

  def query
    cmd = %W[curl -s -A #{USER_AGENT} --cacert #{options.certfile} https://www.google.com/search?q=what+is+my+ip]
    Nokogiri::HTML(%x(#{cmd.shelljoin})).search('[text()*="Your public IP address is"]').css('em').text.strip
  end

  def run arguments = []
    args = parser.parse arguments
    abort parser.help if args.any?
    puts query
  end
end

$0 = File.basename(__FILE__) and Getip.new.run ARGV if $0 == __FILE__
