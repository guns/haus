#!/usr/bin/env ruby
# encoding: utf-8
#
# Copyright (c) 2010 Sung Pae <sung@metablu.com>
# Distributed under the MIT license.
# http://www.opensource.org/licenses/mit-license.php

require 'optparse'
require 'net/http'

class Getip
  IPV4_REGEXP = /\A(\d{1,3}\.){3}\d{1,3}\z/

  def initialize args = []
    @args = args
    @urls = %w[http://metablu.com/whatismyip]
  end

  def options
    OptionParser.new "Get your public IP from: #{@urls.join ', '}"
  end

  def ip
    @ip ||= @urls.inject nil do |str, url|
      str || begin
        res = Net::HTTP.get(URI.parse url).chomp
        res if res =~ IPV4_REGEXP
      rescue
        nil
      end
    end
  end

  def run
    options.parse @args
    ip ? puts(ip) : abort
  end
end

Getip.new(ARGV).run if __FILE__ == $0
