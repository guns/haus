#!/usr/bin/env ruby
# -*- encoding: utf-8 -*-
#
# Copyright (c) 2011 Sung Pae <self@sungpae.com>
# Distributed under the MIT license.
# http://www.opensource.org/licenses/mit-license.php

require 'optparse'
require 'ostruct'
require 'net/http'
require 'ipaddr'

class Getip
  URLS = %w[http://metablu.com/whatismyip]

  class << self
    def addr urls = URLS
      urls.each do |url|
        ip = IPAddr.new Net::HTTP.get(URI.parse url).chomp rescue nil
        return ip.to_s if ip
      end
      'undetermined'
    end
  end

  def parser
    @parser ||= OptionParser.new "Get your public IP from:\n    #{URLS.join "\n    "}"
  end

  def run arguments = []
    args = parser.parse arguments
    abort parser.help unless args.empty?

    ip = self.class.addr
    ip ? puts(ip) : abort
  end
end

$0 = File.basename(__FILE__) and Getip.new.run ARGV if $0 == __FILE__
