# Copyright (c) 2010 Sung Pae <sung@metablu.com>
# Distributed under the MIT license.
# http://www.opensource.org/licenses/mit-license.php

verbose false
task :default => :configure

desc 'Configure Ruby'
task :configure do
  configure = File.expand_path 'configure'
  system 'autoconf' unless File.executable? configure

  cmd = [configure]

  # prefer /opt/ruby/x.x PREFIX
  if ENV['PREFIX']
    cmd << '--prefix=' + ENV['PREFIX']
  else
    ver = File.read('version.h')[/RUBY_VERSION\W*(\d\.\d\.\d)/, 1].split '.'
    cmd << '--prefix=/opt/ruby/%d.%d' % ver[0..1]
  end

  if RUBY_PLATFORM[/darwin/]
    # Use an authentic GNU readline
    if system 'which brew &>/dev/null'
      cmd << '--with-readline-dir=' + %x(brew --prefix readline).chomp
    elsif File.directory? '/opt/local'
      cmd << '--with-readline-dir=/opt/local'
    end

    # OS X Lion's default compiler is llvm; use gcc for the time being
    cc = %x(command -v cc).chomp
    if File.symlink? cc and File.readlink(cc) =~ /llvm/
      gcc = %x(command -v gcc-4.2).chomp
      ENV['CC'] = gcc if File.executable? gcc
    end
  end

  puts cmd.join(' ')
  system *cmd
end
